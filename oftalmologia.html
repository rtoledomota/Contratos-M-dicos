<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oftalmologia - Custos Mensais por Procedimento</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #ffffff; line-height: 1.4; }
        h1 { color: #2679c2; text-align: center; font-size: 2em; font-weight: bold; margin-bottom: 20px; }
        .contrato-block { background-color: #e9f2fa; border-bottom: 2px solid #b5d0e8; padding: 15px; margin: 0 0 20px 0; font-size: 1em; }
        .contrato-block strong { font-weight: bold; }
        .month-tabs { display: flex; margin-bottom: 20px; flex-wrap: wrap; }
        .month-tab { padding: 10px 15px; margin-right: 5px; border: 1px solid #ddd; background-color: #f0f0f0; color: #000; cursor: pointer; font-weight: normal; border-radius: 5px 5px 0 0; margin-bottom: 5px; }
        .month-tab.active { background-color: #2196f3; color: white; font-weight: bold; }
        .summary-cards { display: flex; justify-content: space-between; margin-bottom: 30px; flex-wrap: wrap; }
        .summary-card { flex: 1; margin: 0 5px 10px 5px; padding: 20px; background: linear-gradient(to bottom, #7a4eab, #9c5cd7); color: white; text-align: center; border-radius: 8px; font-weight: bold; min-width: 200px; }
        .summary-card h3 { font-size: 0.9em; margin: 0 0 10px 0; opacity: 0.9; }
        .summary-card .value { font-size: 2em; margin: 0; }
        .procedimentos-title { color: #2679c2; font-size: 1.5em; font-weight: bold; margin: 30px 0 15px 0; }
        .tabela-container { overflow-x: auto; margin-bottom: 30px; border: 1px solid #ddd; border-radius: 0 0 5px 5px; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th, td { padding: 10px; text-align: right; border-bottom: 1px solid #e0e0e0; font-size: 0.9em; }
        th { background-color: #f5f5f5; color: #555; font-weight: bold; text-align: center; white-space: nowrap; min-width: 120px; }
        th:first-child { text-align: left; position: sticky; left: 0; background: #f5f5f5; z-index: 2; }
        tr:nth-child(even) { background-color: #fafafa; }
        tr:hover { background-color: #f0f8ff; }
        .total-row td { font-weight: bold; background-color: #f0f8ff; border-top: 2px solid #ddd; }
        .diferenca { background-color: #fff3cd; font-weight: bold; color: #856404; }
        code { color: #d32f2f; font-weight: bold; }
        .sync-button { background: #2196f3; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 10px 0; font-weight: bold; }
        .sync-button:hover { background: #1976d2; }
        .loading { text-align: center; color: #666; font-style: italic; }
        .error { color: #d32f2f; text-align: center; }
        @media (max-width: 768px) { 
            .summary-cards { flex-direction: column; } 
            .summary-card { margin: 0 0 10px 0; }
            .month-tabs { flex-wrap: wrap; } 
            th:not(:first-child):not(:last-child) { /* This rule from radiologia.html is problematic for this table structure */ }
            table { min-width: 700px; } /* Adjust min-width for smaller screens if needed */
        }
    </style>
</head>
<body>
    <h1>Oftalmologia - Custos Mensais por Procedimento</h1>
    
    <div class="contrato-block" id="contrato-block">
        <!-- Conte√∫do do contrato ser√° carregado aqui pelo JavaScript -->
        Carregando dados do contrato...
    </div>
    
    <div class="month-tabs">
        <div class="month-tab active" data-month="dezembro">Dezembro</div>
        <div class="month-tab" data-month="janeiro">Janeiro</div>
        <div class="month-tab" data-month="fevereiro">Fevereiro</div>
        <div class="month-tab" data-month="marco">Mar√ßo</div>
        <div class="month-tab" data-month="abril">Abril</div>
        <div class="month-tab" data-month="maio">Maio</div>
        <div class="month-tab" data-month="junho">Junho</div>
        <div class="month-tab" data-month="julho">Julho</div>
        <div class="month-tab" data-month="agosto">Agosto</div>
        <div class="month-tab" data-month="setembro">Setembro</div>
        <div class="month-tab" data-month="outubro">Outubro</div>
        <div class="month-tab" data-month="novembro">Novembro</div>
    </div>
    
    <h2 id="month-title">Dezembro</h2>
    
    <div class="summary-cards">
        <div class="summary-card">
            <h3>Contratado/M√™s</h3>
            <div class="value" id="contratado-mes">R$ 0,00</div>
        </div>
        <div class="summary-card">
            <h3>Consumido</h3>
            <div class="value" id="consumido">R$ 0,00</div>
        </div>
        <div class="summary-card">
            <h3>% Utiliza√ß√£o</h3>
            <div class="value" id="utilizacao">0%</div>
        </div>
    </div>
    
    <h2 class="procedimentos-title">Procedimentos Contratados</h2>
    
    <div class="tabela-container">
        <table id="tabela-procedimentos">
            <thead>
                <tr>
                    <th>Procedimento</th>
                    <th>Valor Unit.</th>
                    <th>Qtd Contratada</th>
                    <th>Realizados</th>
                    <th>Valor Total</th>
                </tr>
            </thead>
            <tbody id="tbody-procedimentos">
                <tr><td colspan="5" class="loading">Carregando procedimentos...</td></tr>
            </tbody>
            <tfoot id="tfoot-total">
                <tr class="total-row">
                    <td><strong>TOTAL:</strong></td>
                    <td colspan="3"></td>
                    <td><strong id="total-geral">R$ 0,00</strong></td>
                </tr>
            </tfoot>
        </table>
    </div>
    
    <button class="sync-button" onclick="sincronizarDados()">üîÑ Sincronizar Dados</button>
    
    <script>
        // ATEN√á√ÉO: Substitua esta URL pela URL do seu Web App do Google Apps Script
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyJFfDGA3j31Oph4ezS9_e4zOHTAED-81cJQ-cXx6UNJwcf_WHwkZNVcUsEuiOdcAeE/exec'; 
        
        let currentMonth = 'dezembro'; // M√™s inicial
        let allData = null; // Armazena todos os dados do Apps Script
        
        // Fun√ß√£o para formatar valores monet√°rios
        function formatCurrency(value) {
            return `R$ ${value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        // Fun√ß√£o para formatar percentuais
        function formatPercentage(value) {
            return `${value.toFixed(1)}%`;
        }

        async function carregarDados() {
            try {
                console.log('Carregando dados de:', SCRIPT_URL);
                document.getElementById('tbody-procedimentos').innerHTML = '<tr><td colspan="5" class="loading">Carregando procedimentos...</td></tr>';
                
                const response = await fetch(SCRIPT_URL);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status} - Verifique a implanta√ß√£o do Apps Script.`);
                }
                
                const data = await response.json();
                console.log('Dados recebidos:', data);
                
                if (data.error) {
                    throw new Error(`Erro no Apps Script: ${data.error}`);
                }
                
                allData = data; // Armazena os dados completos
                
                // Atualizar bloco de contrato
                const contratoBlock = document.getElementById('contrato-block');
                if (allData.contrato) {
                    contratoBlock.innerHTML = `
                        <strong>CNPJ:</strong> ${allData.contrato.cnpj || 'N/A'}<br>
                        <strong>Objeto:</strong> ${allData.contrato.objeto || 'N/A'}
                    `;
                }
                
                // Atualizar cards de resumo
                const resumo = allData.resumo || {};
                document.getElementById('contratado-mes').textContent = formatCurrency(resumo.contratadoMensal || 0);
                document.getElementById('consumido').textContent = formatCurrency(resumo.consumido || 0);
                document.getElementById('utilizacao').textContent = formatPercentage(resumo.utilizacao || 0);
                
                // Atualizar a tabela com os dados processados (o Apps Script j√° retorna os totais)
                updateTabela(allData.procedimentos || []);
                
                console.log('Dashboard carregado com sucesso!');
                
            } catch (error) {
                console.error('Erro ao carregar:', error);
                document.getElementById('tbody-procedimentos').innerHTML = `<tr><td colspan="5" class="error">Erro ao carregar dados: ${error.message}. Verifique o Apps Script.</td></tr>`;
                document.getElementById('contrato-block').innerHTML = `<strong>Erro:</strong> ${error.message}`;
                document.getElementById('contratado-mes').textContent = 'R$ 0,00';
                document.getElementById('consumido').textContent = 'R$ 0,00';
                document.getElementById('utilizacao').textContent = '0%';
                document.getElementById('total-geral').textContent = 'R$ 0,00';
            }
        }
        
        function switchMonth(month) {
            currentMonth = month;
            document.querySelectorAll('.month-tab').forEach(tab => tab.classList.remove('active'));
            const activeTab = document.querySelector(`.month-tab[data-month="${month}"]`);
            if (activeTab) activeTab.classList.add('active');
            
            document.getElementById('month-title').textContent = month.charAt(0).toUpperCase() + month.slice(1);
            
            // O Apps Script atualizado j√° retorna procedimentos com totais acumulados.
            // Para filtrar por m√™s, o Apps Script precisaria retornar dados mensais espec√≠ficos.
            // Por enquanto, exibe todos os procedimentos mapeados (totais).
            if (allData && allData.procedimentos) {
                updateTabela(allData.procedimentos);
            } else {
                document.getElementById('tbody-procedimentos').innerHTML = '<tr><td colspan="5" class="loading">Nenhum procedimento encontrado.</td></tr>';
            }
        }
        
        function updateTabela(procedimentos) {
            const tbody = document.getElementById('tbody-procedimentos');
            const totalGeralElement = document.getElementById('total-geral');
            
            tbody.innerHTML = '';
            let totalValorAcumulado = 0;
            
            if (procedimentos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="loading">Nenhum procedimento encontrado.</td></tr>';
            } else {
                procedimentos.forEach(proc => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${proc.procedimento || 'N/A'}</td>
                        <td><code>${formatCurrency(proc.valorUnit || 0)}</code></td>
                        <td>${(proc.qtdContratada || 0).toLocaleString('pt-BR')}</td>
                        <td>${(proc.realizados || 0).toLocaleString('pt-BR')}</td>
                        <td><code>${formatCurrency(proc.valorTotal || 0)}</code></td>
                    `;
                    tbody.appendChild(tr);
                    totalValorAcumulado += (proc.valorTotal || 0);
                });
            }
            
            totalGeralElement.textContent = formatCurrency(totalValorAcumulado);
        }
        
        async function sincronizarDados() {
            await carregarDados();
            alert('Dados sincronizados com sucesso!');
        }
        
        // Adiciona event listeners para as abas de meses
        document.addEventListener('DOMContentLoaded', () => {
            const monthTabs = document.querySelectorAll('.month-tab');
            monthTabs.forEach(tab => {
                tab.addEventListener('click', () => switchMonth(tab.dataset.month));
            });
            
            // Carrega os dados e ativa a aba do m√™s inicial ao carregar a p√°gina
            carregarDados().then(() => {
                switchMonth(currentMonth); 
            });
        });
    </script>
</body>
</html>
