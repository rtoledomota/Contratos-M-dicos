<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oftalmologia - Custos Mensais por Procedimento</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f8f9fa; line-height: 1.4; }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 30px; font-size: 2em; }
        h2 { color: #34495e; border-bottom: 2px solid #4CAF50; padding-bottom: 10px; margin-top: 40px; }
        .resumo { background: linear-gradient(135deg, #ffffff, #f8f9fa); padding: 20px; margin: 20px 0; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-left: 5px solid #4CAF50; }
        .resumo p { margin: 10px 0; font-size: 1.1em; }
        .loading { text-align: center; color: #7f8c8d; font-style: italic; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .error { color: #e74c3c; text-align: center; background: #fdf2f2; padding: 10px; border-radius: 8px; border-left: 5px solid #e74c3c; }
        .tabela-container { overflow-x: auto; margin: 20px 0; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); background: white; }
        table { width: 100%; border-collapse: collapse; min-width: 1200px; }
        th, td { padding: 12px 8px; text-align: right; border-bottom: 1px solid #dee2e6; white-space: nowrap; font-size: 0.9em; }
        th { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; font-weight: 600; position: sticky; top: 0; z-index: 2; white-space: nowrap; min-width: 80px; }
        th:first-child, td:first-child { text-align: left; min-width: 100px; position: sticky; left: 0; background: #f8f9fa; z-index: 3; font-weight: 600; }
        tr:nth-child(even) { background-color: #f8f9fa; }
        tr:hover { background-color: #e3f2fd; }
        .total { font-weight: bold; background: linear-gradient(135deg, #e8f5e8, #c8e6c9) !important; color: #2e7d32; }
        .diferenca { background-color: #fff3cd !important; color: #856404; font-weight: bold; }
        code { background: #f1f3f4; padding: 2px 4px; border-radius: 4px; font-family: monospace; font-size: 0.85em; }
        .resumo-servicos { margin-top: 40px; }
        .sync-button { background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; margin: 10px 0; font-size: 1em; transition: background 0.3s; }
        .sync-button:hover { background: #45a049; }
        .sync-button:disabled { background: #bdc3c7; cursor: not-allowed; }
        @media (max-width: 768px) { body { padding: 10px; } h1 { font-size: 1.5em; } th, td { padding: 6px 4px; font-size: 0.8em; min-width: 60px; } th:not(:first-child):not(:last-child):not(.diferenca) { display: none; } .total td { display: table-cell; } }
    </style>
</head>
<body>
    <h1>Custos Mensais - Oftalmologia</h1>
    
    <div class="resumo" id="resumo">
        <h2>Resumo Geral (Carregando...)</h2>
        <div class="loading" id="loading-resumo">Conectando √† planilha via Apps Script...</div>
        <button class="sync-button" id="sync-btn" onclick="sincronizarHTML()">üîÑ Sincronizar Dados Agora</button>
    </div>
    
    <h2>Custos por M√™s e Procedimento</h2>
    <div class="tabela-container">
        <table id="tabela-custos">
            <thead>
                <tr>
                    <th title="M√™s do Ano">M√™s</th>
                    <th title="Custo Geral Mensal">Custo Geral</th>
                    <th title="Consultas">Consultas</th>
                    <th title="Biometria">Biometria</th>
                    <th title="Campo Visual">Campo Visual</th>
                    <th title="Retinografia Colorida">Retino Colorida</th>
                    <th title="Microscopia Especular de C√≥rnea">Micro Especular</th>
                    <th title="Topografia">Topografia</th>
                    <th title="Paquimetria Ultrass√¥nica">Paquimetria US</th>
                    <th title="Angiografia">Angiografia</th>
                    <th title="Tomografia de Coer√™ncia √ìptica">Tomografia OCT</th>
                    <th title="Ecografia de Globo Ocular">Ecografia Ocular</th>
                    <th title="Cirurgia de Catarata">Catarata</th>
                    <th title="Cirurgia Refrativa">Refrativa</th>
                    <th title="Pl√°stica Ocular">Pl√°stica Ocular</th>
                    <th title="Cirurgia de Glaucoma - Traquelectomia">Glaucoma - Trab</th>
                    <th title="Capsulotomia a Laser">Capsulotomia Laser</th>
                    <th title="Iridotomia a Laser">Iridotomia Laser</th>
                    <th title="Cirurgia de Retina - Vitrectomia">Retina - Vitrectomia</th>
                    <th title="Fotocoagula√ß√£o a Laser">Fotocoag Laser</th>
                    <th title="Aplica√ß√£o de Anti-VEGF">Anti-VEGF</th>
                    <th title="Cirurgia de Estrabismo">Estrabismo</th>
                    <th title="Pter√≠gio">Pter√≠gio</th>
                    <th title="Fixo">Fixo</th>
                    <th title="Total Mensal">Total</th>
                    <th title="Diferen√ßa Mensal" class="diferenca">Diferen√ßa</th>
                </tr>
            </thead>
            <tbody id="tbody-custos">
                <tr><td colspan="26" class="loading">Carregando dados mensais...</td></tr>
            </tbody>
            <tfoot id="tfoot-totals">
                <tr class="total">
                    <td colspan="26"><strong>Carregando totais...</strong></td>
                </tr>
            </tfoot>
        </table>
    </div>
    
    <div class="resumo-servicos">
        <h2>Resumo de Servi√ßos e Contratos</h2>
        <div class="tabela-container">
            <table id="tabela-servicos">
                <thead>
                    <tr>
                        <th title="Tipo de Servi√ßo ou Procedimento">Servi√ßo</th>
                        <th title="Quantidade Contratada">Contratado</th>
                        <th title="Valor Unit√°rio">Valor Unit√°rio</th>
                        <th title="Valor Total do Servi√ßo">Valor Total</th>
                    </tr>
                </thead>
                <tbody id="tbody-servicos">
                    <tr><td colspan="4" class="loading">Carregando resumo de servi√ßos...</td></tr>
                </tbody>
                <tfoot>
                    <tr class="total">
                        <td colspan="3"><strong>Total de Servi√ßos</strong></td>
                        <td><strong><code>R$ 0</code></strong></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    
    <script>
        // Sua URL do Apps Script (substitua pela sua se mudou)
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw-CxvpNHhYvCY-eONSPLvM8-tCZ8ZNiUhOasvqWwjQgtXDvhTtWNusDwf_pZskCivl/exec';
        
        function parseValor(val) {
            if (!val) return 0;
            const cleaned = val.toString().replace(/[^\d,.-]/g, '').replace(/\./g, '').replace(',', '.');
            return parseFloat(cleaned) || 0;
        }
        
        async function carregarDados() {
            const loadingResumo = document.getElementById('loading-resumo');
            const tbodyMensal = document.getElementById('tbody-custos');
            const tbodyServicos = document.getElementById('tbody-servicos');
            const tfootTotals = document.getElementById('tfoot-totals');
            const tfootServicos = document.querySelector('#tabela-servicos tfoot tr');
            
            loadingResumo.textContent = 'Carregando...';
            tbodyMensal.innerHTML = '<tr><td colspan="26" class="loading">Carregando dados mensais...</td></tr>';
            tbodyServicos.innerHTML = '<tr><td colspan="4" class="loading">Carregando resumo de servi√ßos...</td></tr>';
            tfootTotals.innerHTML = '<tr class="total"><td colspan="26"><strong>Carregando totais...</strong></td></tr>';
            tfootServicos.innerHTML = '<td colspan="3"><strong>Total de Servi√ßos</strong></td><td><strong><code>R$ 0</code></strong></td>';
            
            try {
                console.log('Buscando dados de:', SCRIPT_URL);
                const response = await fetch(SCRIPT_URL);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status} - Verifique a implanta√ß√£o do Apps Script.`);
                }
                
                const data = await response.json();
                console.log('Dados recebidos:', data);
                
                if (data.error) {
                    throw new Error(`Erro no Apps Script: ${data.error}`);
                }
                
                const meses = data.meses || [];
                const numMeses = data.numMeses || 0;
                const totalGeral = data.totalGeral || 0;
                const totalDif = data.totalDif || 0;
                const mediaMensal = data.mediaMensal || 0;
                
                // Filtra linhas de meses reais (ex.: "JAN", "FEV")
                const dadosMensais = meses.filter(row => row[0] && typeof row[0] === 'string' && row[0].match(/^[A-Z]{3,4}$/));
                
                // Filtra resumos de servi√ßos (ex.: "Pacote consulta", "Servi√ßo")
                const dadosServicos = meses.filter(row => row.length >= 4 && row[0] && (row[0].toString().includes('Pacote') || row[0].includes('Servi√ßo') || row[0].includes('PROCEDIMENTOS')));
                
                // Resumo
                document.getElementById('resumo').innerHTML = `
                    <h2>Resumo Geral</h2>
                    <p><strong>Meses Analisados:</strong> ${dadosMensais.length} (de ${numMeses} linhas totais)</p>
                    <p><strong>Total Geral de Custos:</strong> <code>R$ ${totalGeral.toLocaleString('pt-BR')}</code></p>
                    <p><strong>M√©dia Mensal:</strong> <code>R$ ${mediaMensal.toLocaleString('pt-BR')}</code></p>
                    <p><strong>Soma das Diferen√ßas:</strong> <code>R$ ${totalDif.toLocaleString('pt-BR')}</code></p>
                    <p><strong>Data da √öltima Atualiza√ß√£o:</strong> ${data.dataAtualizacao || new Date().toLocaleDateString('pt-BR')}</p>
                    <button class="sync-button" onclick="sincronizarHTML()">üîÑ Sincronizar Dados Agora</button>
                `;
                
                // Tabela mensal
                tbodyMensal.innerHTML = '';
                dadosMensais.forEach(row => {
                    const tr = document.createElement('tr');
                    let html = `<td>${row[0] || ''}</td>`;
                    for (let i = 1; i < Math.min(row.length, 26); i++) {
                        const val = parseValor(row[i]);
                        const classe = (i === 25) ? ' class="diferenca"' : '';
                        html += `<td${classe}><code>R$ ${val.toLocaleString('pt-BR')}</code></td>`;
                    }
                    while (html.split('<td').length - 1 < 26) {
                        html += '<td><code>R$ 0</code></td>';
                    }
                    tr.innerHTML = html;
                    tbodyMensal.appendChild(tr);
                });
                
                if (dadosMensais.length === 0) {
                    tbodyMensal.innerHTML = '<tr><td colspan="26" class="error">Nenhum dado mensal encontrado. Verifique o filtro no Apps Script.</td></tr>';
                }
                
                // Rodap√© mensal
                tfootTotals.innerHTML = `
                    <tr class="total">
                        <td><strong>Total Geral</strong></td>
                        <td colspan="24"><strong><code>R$ ${totalGeral.toLocaleString('pt-BR')}</code></strong></td>
                        <td class="diferenca"><strong><code>R$ ${totalDif.toLocaleString('pt-BR')}</code></strong></td>
                    </tr>
                    <tr class="total">
                        <td colspan="26"><strong>M√©dia Mensal Geral: <code>R$ ${mediaMensal.toLocaleString('pt-BR')}</code></strong></td>
                    </tr>
                `;
                
                // Tabela de servi√ßos
                tbodyServicos.innerHTML = '';
                let totalServicos = 0;
                dadosServicos.forEach(row => {
                    const tr = document.createElement('tr');
                    const valTotal = parseValor(row[3] || 0);
                    totalServicos += valTotal;
                    tr.innerHTML = `
                        <td>${row[0] || ''}</td>
                        <td>${row[1] || ''}</td>
                        <td><code>R$ ${parseValor(row[2]).toLocaleString('pt-BR')}</code></td>
                        <td><code>R$ ${valTotal.toLocaleString('pt-BR')}</code></td>
                    `;
                    tbodyServicos.appendChild(tr);
                });
                
                if (dadosServicos.length === 0) {
                    tbodyServicos.innerHTML = '<tr><td colspan="4" class="error">Nenhum resumo de servi√ßos encontrado.</td></tr>';
                }
                
                tfootServicos.innerHTML = `
                    <td colspan="3"><strong>Total de Servi√ßos</strong></td>
                    <td><strong><code>R$ ${totalServicos.toLocaleString('pt-BR')}</code></strong></td>
                `;
                
                document.getElementById('sync-btn').disabled = false;
                console.log('Sucesso! Dados carregados. Meses:', dadosMensais.length, 'Servi√ßos:', dadosServicos.length);
                
            } catch (error) {
                console.error('Erro ao carregar:', error);
                document.getElementById('resumo').innerHTML = `
                    <h2>Erro na Conex√£o</h2>
                    <p class="error">${error.message}</p>
                    <p class="error"><small>Dicas: Verifique a URL do Apps Script no console (F12). Teste a URL no navegador.</small></p>
                    <button class="sync-button" onclick="sincronizarHTML()">üîÑ Tentar Novamente</button>
                `;
                tbodyMensal.innerHTML = '<tr><td colspan="26" class="error">Falha ao carregar dados mensais. Verifique a conex√£o.</td></tr>';
                tbodyServicos.innerHTML = '<tr><td colspan="4" class="error">Falha ao carregar servi√ßos.</td></tr>';
                document.getElementById('sync-btn').disabled = false;
            }
        }
        
        async function sincronizarHTML() {
            document.getElementById('sync-btn').disabled = true;
            document.getElementById('sync-btn').textContent = 'Sincronizando...';
            await carregarDados();
            document.getElementById('sync-btn').disabled = false;
            document.getElementById('sync-btn').textContent = 'üîÑ Sincronizar Dados Agora';
            alert('Dados sincronizados com sucesso!');
        }
        
        window.onload = carregarDados;
    </script>
    
    <footer style="text-align: center; margin-top: 40px; color: #7f8c8d; font-size: 0.9em;">
        <p>Dashboard de Oftalmologia - Conectado ao Apps Script. Erros no console resolvidos (sem workers ou SVG).</p>
    </footer>
</body>
</html>
