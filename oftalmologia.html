<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oftalmologia - Custos Mensais por Procedimento</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #ffffff; line-height: 1.4; }
        h1 { color: #2679c2; text-align: center; font-size: 2em; font-weight: bold; margin-bottom: 20px; }
        .contrato-block { background-color: #e9f2fa; border-bottom: 2px solid #b5d0e8; padding: 15px; margin: 0 0 20px 0; font-size: 1em; }
        .contrato-block strong { font-weight: bold; }
        .month-tabs { display: flex; margin-bottom: 20px; }
        .month-tab { padding: 10px 15px; margin-right: 5px; border: 1px solid #ddd; background-color: #f0f0f0; color: #000; cursor: pointer; font-weight: normal; border-radius: 5px 5px 0 0; }
        .month-tab.active { background-color: #2196f3; color: white; font-weight: bold; }
        .summary-cards { display: flex; justify-content: space-between; margin-bottom: 30px; }
        .summary-card { flex: 1; margin: 0 5px; padding: 20px; background: linear-gradient(to bottom, #7a4eab, #9c5cd7); color: white; text-align: center; border-radius: 8px; font-weight: bold; }
        .summary-card h3 { font-size: 0.9em; margin: 0 0 10px 0; opacity: 0.9; }
        .summary-card .value { font-size: 2em; margin: 0; }
        .procedimentos-title { color: #2679c2; font-size: 1.5em; font-weight: bold; margin: 30px 0 15px 0; }
        .tabela-container { overflow-x: auto; margin-bottom: 30px; border: 1px solid #ddd; border-radius: 0 0 5px 5px; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th, td { padding: 10px; text-align: right; border-bottom: 1px solid #e0e0e0; font-size: 0.9em; }
        th { background-color: #f5f5f5; color: #555; font-weight: bold; text-align: center; white-space: nowrap; min-width: 120px; }
        th:first-child { text-align: left; position: sticky; left: 0; background: #f5f5f5; z-index: 2; }
        tr:nth-child(even) { background-color: #fafafa; }
        tr:hover { background-color: #f0f8ff; }
        .total-row td { font-weight: bold; background-color: #f0f8ff; border-top: 2px solid #ddd; }
        .diferenca { background-color: #fff3cd; font-weight: bold; color: #856404; }
        code { color: #d32f2f; font-weight: bold; }
        .sync-button { background: #2196f3; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 10px 0; font-weight: bold; }
        .sync-button:hover { background: #1976d2; }
        .loading { text-align: center; color: #666; font-style: italic; }
        .error { color: #d32f2f; text-align: center; }
        @media (max-width: 768px) { .summary-cards { flex-direction: column; } .month-tabs { flex-wrap: wrap; } th:not(:first-child):not(:last-child) { display: none; } }
    </style>
</head>
<body>
    <h1>Oftalmologia - Custos Mensais por Procedimento</h1>
    
    <div class="contrato-block" id="contrato-block">
        <strong>Contrato:</strong> 0775/2020 | <strong>Empresa:</strong> EL DIAGNÃ“STICO LTDA<br>
        <strong>CNPJ:</strong> 18.505.205/0001-94<br>
        <strong>Objeto:</strong> PRESTAÃ‡ÃƒO DE SERVIÃ‡OS EM OFTALMOLOGIA
    </div>
    
    <div class="month-tabs">
        <div class="month-tab active" onclick="switchMonth('dezembro')">Dezembro</div>
        <div class="month-tab" onclick="switchMonth('janeiro')">Janeiro</div>
        <div class="month-tab" onclick="switchMonth('fevereiro')">Fevereiro</div>
        <div class="month-tab" onclick="switchMonth('marco')">MarÃ§o</div>
        <div class="month-tab" onclick="switchMonth('abril')">Abril</div>
        <div class="month-tab" onclick="switchMonth('maio')">Maio</div>
        <div class="month-tab" onclick="switchMonth('junho')">Junho</div>
        <div class="month-tab" onclick="switchMonth('julho')">Julho</div>
        <div class="month-tab" onclick="switchMonth('agosto')">Agosto</div>
        <div class="month-tab" onclick="switchMonth('setembro')">Setembro</div>
        <div class="month-tab" onclick="switchMonth('outubro')">Outubro</div>
        <div class="month-tab" onclick="switchMonth('novembro')">Novembro</div>
    </div>
    
    <h2 id="month-title">Dezembro</h2>
    
    <div class="summary-cards">
        <div class="summary-card">
            <h3>Contratado/MÃªs</h3>
            <div class="value" id="contratado-mes">R$ 0</div>
        </div>
        <div class="summary-card">
            <h3>Consumido</h3>
            <div class="value" id="consumido">R$ 0</div>
        </div>
        <div class="summary-card">
            <h3>% UtilizaÃ§Ã£o</h3>
            <div class="value" id="utilizacao">0%</div>
        </div>
    </div>
    
    <h2 class="procedimentos-title">Procedimentos Contratados</h2>
    
    <div class="tabela-container">
        <table id="tabela-procedimentos">
            <thead>
                <tr>
                    <th>Procedimento</th>
                    <th>Valor Unit.</th>
                    <th>Qtd Contratada</th>
                    <th>Realizados</th>
                    <th>Valor Total</th>
                </tr>
            </thead>
            <tbody id="tbody-procedimentos">
                <tr><td colspan="5" class="loading">Carregando procedimentos...</td></tr>
            </tbody>
            <tfoot id="tfoot-total">
                <tr class="total-row">
                    <td><strong>TOTAL:</strong></td>
                    <td colspan="3"></td>
                    <td><strong id="total-geral">R$ 0</strong></td>
                </tr>
            </tfoot>
        </table>
    </div>
    
    <button class="sync-button" onclick="sincronizarDados()">ðŸ”„ Sincronizar Dados</button>
    
    <script>
        const SCRIPT_URL = 'https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLjB5Jfzc_1Iv0dJL258tl_CKyDjMRjjrFQIMzZdxs6n9nZJNwqdi8BSrsKROxpGGLa6QkbECxJdPtlsdUsp8Q8N4UIFtGJi-5ZuOmEMtJKi-Po_HgEnaAH6OAwDdJjtZ6PscUsAg9r8Jdk2qkdihomYgl9HkyqesaXEYNZkKrxTYQ3QpBVoUrKW_uI_RNGS3Ti6q5xMnAdDDtLRieP_fpTjQtShqgb7jr-kkwyhjDmGVS3srJNZRGsapSV-Dk_2Ug-DCTjekHdganyCi_luzkOrQog1UQ&lib=M02wSb2Q4y3tUGugoSnRmHpS3VTlhs1uH'; // URL do seu Apps Script atualizada
        
        let currentMonth = 'dezembro';
        let allData = [];
        
        function parseValor(val) {
            if (!val) return 0;
            const cleaned = val.toString().replace(/[^\d,.-]/g, '').replace(/\./g, '').replace(',', '.');
            return parseFloat(cleaned) || 0;
        }
        
        async function carregarDados() {
            try {
                console.log('Carregando dados de:', SCRIPT_URL);
                const response = await fetch(SCRIPT_URL);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status} - Verifique a implantaÃ§Ã£o do Apps Script.`);
                }
                
                const data = await response.json();
                console.log('Dados recebidos:', data);
                
                if (data.error) {
                    throw new Error(`Erro no Apps Script: ${data.error}`);
                }
                
                allData = data;
                
                // Extrair contrato
                const contratoBlock = document.getElementById('contrato-block');
                if (data.contrato) {
                    contratoBlock.innerHTML = `
                        <strong>CNPJ:</strong> ${data.contrato.cnpj || ''}<br>
                        <strong>Objeto:</strong> ${data.contrato.objeto || ''}
                    `;
                }
                
                // Atualizar cards de resumo
                const resumo = data.resumo || {};
                document.getElementById('contratado-mes').textContent = `R$ ${resumo.contratadoMensal ? resumo.contratadoMensal.toLocaleString('pt-BR') : 0}`;
                document.getElementById('consumido').textContent = `R$ ${resumo.consumido ? resumo.consumido.toLocaleString('pt-BR') : 0}`;
                document.getElementById('utilizacao').textContent = `${resumo.utilizacao ? resumo.utilizacao.toFixed(1) : 0}%`;
                
                // Filtrar procedimentos por mÃªs (exemplo para 'dezembro')
                const procedimentos = data.procedimentos || [];
                updateTabela(procedimentos);
                
                // Configurar abas de meses
                const monthTabs = document.querySelectorAll('.month-tab');
                monthTabs.forEach((tab, index) => {
                    const month = tab.textContent.toLowerCase();
                    tab.onclick = () => switchMonth(month);
                });
                
                console.log('Dashboard carregado com sucesso!');
                
            } catch (error) {
                console.error('Erro ao carregar:', error);
                document.getElementById('tbody-procedimentos').innerHTML = '<tr><td colspan="5" class="error">Erro ao carregar dados. Verifique o Apps Script.</td></tr>';
            }
        }
        
        function switchMonth(month) {
            currentMonth = month;
            document.querySelectorAll('.month-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('month-title').textContent = month.charAt(0).toUpperCase() + month.slice(1);
            
            // Filtrar procedimentos para o mÃªs atual (lÃ³gica simples baseada em dados)
            const procedimentos = allData.procedimentos.filter(proc => proc.mes === currentMonth) || allData.procedimentos || [];
            updateTabela(procedimentos);
        }
        
        function updateTabela(procedimentos) {
            const tbody = document.getElementById('tbody-procedimentos');
            const totalGeral = document.getElementById('total-geral');
            
            tbody.innerHTML = '';
            let totalValor = 0;
            procedimentos.forEach(proc => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${proc.procedimento}</td>
                    <td><code>R$ ${proc.valorUnit.toLocaleString('pt-BR')}</code></td>
                    <td>${proc.qtdContratada.toLocaleString()}</td>
                    <td>${proc.realizados.toLocaleString()}</td>
                    <td><code>R$ ${proc.valorTotal.toLocaleString('pt-BR')}</code></td>
                `;
                tbody.appendChild(tr);
                totalValor += proc.valorTotal;
            });
            
            if (procedimentos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="loading">Nenhum procedimento encontrado para este mÃªs.</td></tr>';
            }
            
            totalGeral.textContent = `R$ ${totalValor.toLocaleString('pt-BR')}`;
        }
        
        async function sincronizarDados() {
            await carregarDados();
            alert('Dados sincronizados com sucesso!');
        }
        
        window.onload = carregarDados;
    </script>
</body>
</html>
