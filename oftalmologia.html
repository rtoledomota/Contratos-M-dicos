<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oftalmologia - Custos Mensais por Procedimento</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #ffffff; line-height: 1.4; color: #333; }
        h1 { color: #2679c2; text-align: center; font-size: 2.2em; font-weight: bold; margin-bottom: 25px; }
        .contrato-block { background-color: #e9f2fa; border-bottom: 2px solid #b5d0e8; padding: 15px 20px; margin: 0 0 25px 0; font-size: 1em; border-radius: 5px; }
        .contrato-block strong { font-weight: bold; color: #2679c2; }
        .contrato-block p { margin: 5px 0; }
        .month-tabs { display: flex; flex-wrap: wrap; margin-bottom: 20px; border-bottom: 1px solid #ddd; }
        .month-tab { padding: 10px 15px; margin-right: 5px; border: 1px solid #ddd; border-bottom: none; background-color: #f0f0f0; color: #555; cursor: pointer; font-weight: normal; border-radius: 5px 5px 0 0; transition: all 0.2s ease-in-out; }
        .month-tab:hover { background-color: #e0e0e0; }
        .month-tab.active { background-color: #2196f3; color: white; font-weight: bold; border-color: #2196f3; }
        .summary-cards { display: flex; justify-content: space-between; flex-wrap: wrap; margin-bottom: 30px; gap: 15px; }
        .summary-card { flex: 1; min-width: 280px; padding: 20px; background: linear-gradient(to bottom right, #7a4eab, #9c5cd7); color: white; text-align: center; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .summary-card h3 { font-size: 0.9em; margin: 0 0 10px 0; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; }
        .summary-card .value { font-size: 2.2em; margin: 0; font-weight: bold; }
        .procedimentos-title { color: #2679c2; font-size: 1.8em; font-weight: bold; margin: 30px 0 15px 0; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .tabela-container { overflow-x: auto; margin-bottom: 30px; border: 1px solid #ddd; border-radius: 0 0 5px 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th, td { padding: 12px 15px; text-align: right; border-bottom: 1px solid #e0e0e0; font-size: 0.95em; }
        th { background-color: #f5f5f5; color: #555; font-weight: bold; text-align: center; white-space: nowrap; min-width: 120px; text-transform: uppercase; }
        th:first-child { text-align: left; position: sticky; left: 0; background: #f5f5f5; z-index: 2; }
        td:first-child { text-align: left; }
        tr:nth-child(even) { background-color: #fafafa; }
        tr:hover { background-color: #f0f8ff; }
        .total-row td { font-weight: bold; background-color: #e9f2fa; border-top: 2px solid #b5d0e8; color: #2679c2; }
        .diferenca { background-color: #fff3cd; font-weight: bold; color: #856404; }
        code { color: #d32f2f; font-weight: bold; background-color: #ffebee; padding: 2px 4px; border-radius: 3px; }
        .sync-button { display: block; width: fit-content; margin: 20px auto; background: #2196f3; color: white; padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1em; transition: background 0.3s ease; }
        .sync-button:hover { background: #1976d2; }
        .loading { text-align: center; color: #666; font-style: italic; padding: 20px; }
        .error { color: #d32f2f; text-align: center; padding: 20px; font-weight: bold; }
        
        @media (max-width: 768px) {
            body { padding: 10px; }
            h1 { font-size: 1.8em; }
            .contrato-block { font-size: 0.9em; padding: 10px 15px; }
            .summary-cards { flex-direction: column; gap: 10px; }
            .summary-card { min-width: unset; }
            .summary-card .value { font-size: 1.8em; }
            .procedimentos-title { font-size: 1.4em; }
            .month-tab { padding: 8px 10px; margin-right: 3px; font-size: 0.9em; }
            th, td { padding: 8px 10px; font-size: 0.85em; }
        }
    </style>
</head>
<body>
    <h1>Oftalmologia - Dashboard de Contratos</h1>
    
    <div class="contrato-block" id="contrato-block">
        <p><strong>Contrato:</strong> <span id="contrato-numero">N/A</span></p>
        <p><strong>Empresa:</strong> <span id="contrato-empresa">N/A</span></p>
        <p><strong>CNPJ:</strong> <span id="contrato-cnpj">N/A</span></p>
        <p><strong>Objeto:</strong> <span id="contrato-objeto">N/A</span></p>
        <p><strong>Valor Mensal Estimado:</strong> <span id="contrato-valor-mensal">R$ 0,00</span></p>
        <p><strong>Valor Global Estimado:</strong> <span id="contrato-valor-global">R$ 0,00</span></p>
        <p><strong>Ãšltima AtualizaÃ§Ã£o:</strong> <span id="data-atualizacao">N/A</span></p>
    </div>
    
    <div class="month-tabs" id="month-tabs-container">
        <!-- Abas de meses serÃ£o geradas dinamicamente -->
    </div>
    
    <h2 id="month-title">Resumo Mensal</h2>
    
    <div class="summary-cards">
        <div class="summary-card">
            <h3>Contratado/MÃªs</h3>
            <div class="value" id="contratado-mes">R$ 0,00</div>
        </div>
        <div class="summary-card">
            <h3>Consumido Total</h3>
            <div class="value" id="consumido-total">R$ 0,00</div>
        </div>
        <div class="summary-card">
            <h3>% UtilizaÃ§Ã£o Global</h3>
            <div class="value" id="utilizacao-global">0%</div>
        </div>
    </div>
    
    <h2 class="procedimentos-title">Procedimentos Contratados e Realizados</h2>
    
    <div class="tabela-container">
        <table id="tabela-procedimentos">
            <thead>
                <tr>
                    <th>Procedimento</th>
                    <th>Valor Unit.</th>
                    <th>Qtd Contratada</th>
                    <th>Realizados</th>
                    <th>Valor Total</th>
                </tr>
            </thead>
            <tbody id="tbody-procedimentos">
                <tr><td colspan="5" class="loading">Carregando procedimentos...</td></tr>
            </tbody>
            <tfoot id="tfoot-total">
                <tr class="total-row">
                    <td><strong>TOTAL GERAL:</strong></td>
                    <td colspan="3"></td>
                    <td><strong id="total-geral-procedimentos">R$ 0,00</strong></td>
                </tr>
            </tfoot>
        </table>
    </div>
    
    <button class="sync-button" onclick="sincronizarDados()">ðŸ”„ Sincronizar Dados</button>
    
    <script>
        // --- IMPORTANTE: ATUALIZE ESTA URL APÃ“S O DEPLOY DO SEU APPS SCRIPT COMO WEB APP ---
        const SCRIPT_URL = 'SUA_URL_DO_WEB_APP_AQUI'; 
        
        let allDashboardData = null; // Armazena todos os dados do Apps Script
        let currentMonth = 'dezembro'; // MÃªs inicial padrÃ£o
        const MONTH_NAMES = ['janeiro', 'fevereiro', 'marÃ§o', 'abril', 'maio', 'junho', 'julho', 'agosto', 'setembro', 'outubro', 'novembro', 'dezembro'];

        // FunÃ§Ã£o auxiliar para formatar valores monetÃ¡rios
        function formatCurrency(value) {
            return `R$ ${value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        // FunÃ§Ã£o auxiliar para formatar porcentagens
        function formatPercentage(value) {
            return `${value.toFixed(1).replace('.', ',')}%`;
        }
        
        async function carregarDados() {
            try {
                document.getElementById('tbody-procedimentos').innerHTML = '<tr><td colspan="5" class="loading">Carregando dados do Apps Script...</td></tr>';
                console.log('Carregando dados de:', SCRIPT_URL);
                
                const response = await fetch(SCRIPT_URL);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status} - Verifique a implantaÃ§Ã£o do Apps Script ou a URL.`);
                }
                
                const data = await response.json();
                console.log('Dados recebidos:', data);
                
                if (data.error) {
                    throw new Error(`Erro no Apps Script: ${data.error}`);
                }
                
                allDashboardData = data; // Armazena todos os dados
                
                // --- Atualizar Bloco de Contrato ---
                const contract = allDashboardData.contract || {};
                document.getElementById('contrato-numero').textContent = contract.numero || 'N/A';
                document.getElementById('contrato-empresa').textContent = contract.razaoSocial || 'N/A';
                document.getElementById('contrato-cnpj').textContent = contract.cnpj || 'N/A';
                document.getElementById('contrato-objeto').textContent = contract.objetoContrato || 'N/A';
                document.getElementById('contrato-valor-mensal').textContent = formatCurrency(contract.valorEstimadoMensal);
                document.getElementById('contrato-valor-global').textContent = formatCurrency(contract.valorEstimadoGlobal);
                document.getElementById('data-atualizacao').textContent = allDashboardData.dataAtualizacao || 'N/A';

                // --- Atualizar Cards de Resumo ---
                const summary = allDashboardData.summary || {};
                document.getElementById('contratado-mes').textContent = formatCurrency(summary.contratadoMensal);
                document.getElementById('consumido-total').textContent = formatCurrency(summary.consumido);
                document.getElementById('utilizacao-global').textContent = formatPercentage(summary.utilizacao);
                
                // --- Gerar Abas de Meses Dinamicamente ---
                renderMonthTabs();
                
                // --- Atualizar Tabela de Procedimentos para o mÃªs atual ---
                updateTabela(allDashboardData.procedures); // O Apps Script jÃ¡ retorna os totais acumulados
                
                console.log('Dashboard carregado com sucesso!');
                
            } catch (error) {
                console.error('Erro ao carregar dados do dashboard:', error);
                document.getElementById('tbody-procedimentos').innerHTML = `<tr><td colspan="5" class="error">Erro ao carregar dados: ${error.message}. Verifique o Apps Script e a URL.</td></tr>`;
            }
        }

        function renderMonthTabs() {
            const monthTabsContainer = document.getElementById('month-tabs-container');
            monthTabsContainer.innerHTML = ''; // Limpa abas existentes
            MONTH_NAMES.forEach(month => {
                const tab = document.createElement('div');
                tab.classList.add('month-tab');
                tab.textContent = month.charAt(0).toUpperCase() + month.slice(1);
                tab.onclick = () => switchMonth(month);
                if (month === currentMonth) {
                    tab.classList.add('active');
                }
                monthTabsContainer.appendChild(tab);
            });
        }
        
        function switchMonth(month) {
            currentMonth = month;
            document.querySelectorAll('.month-tab').forEach(tab => tab.classList.remove('active'));
            const activeTab = Array.from(document.querySelectorAll('.month-tab')).find(tab => tab.textContent.toLowerCase() === month);
            if (activeTab) activeTab.classList.add('active');
            
            document.getElementById('month-title').textContent = `Resumo Mensal (${month.charAt(0).toUpperCase() + month.slice(1)})`;
            
            // A lÃ³gica de filtragem por mÃªs precisa ser implementada aqui se o Apps Script retornar dados mensais.
            // Atualmente, o Apps Script retorna dados acumulados/totais.
            // Se vocÃª quiser ver dados por mÃªs, o Apps Script precisaria ser modificado para retornar um objeto de procedimentos por mÃªs.
            // Por enquanto, a tabela exibe os procedimentos totais mapeados.
            if (allDashboardData && allDashboardData.procedures) {
                updateTabela(allDashboardData.procedures);
            }
        }
        
        function updateTabela(procedimentos) {
            const tbody = document.getElementById('tbody-procedimentos');
            const totalGeralProcedimentos = document.getElementById('total-geral-procedimentos');
            
            tbody.innerHTML = '';
            let totalValorAcumulado = 0;

            if (!procedimentos || procedimentos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="loading">Nenhum procedimento encontrado.</td></tr>';
                totalGeralProcedimentos.textContent = formatCurrency(0);
                return;
            }

            procedimentos.forEach(proc => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${proc.nome || 'N/A'}</td>
                    <td><code>${formatCurrency(proc.valorUnit)}</code></td>
                    <td>${proc.qtdContratada.toLocaleString('pt-BR')}</td>
                    <td>${proc.realizados.toLocaleString('pt-BR')}</td>
                    <td><code>${formatCurrency(proc.valorTotal)}</code></td>
                `;
                tbody.appendChild(tr);
                totalValorAcumulado += proc.valorTotal;
            });
            
            totalGeralProcedimentos.textContent = formatCurrency(totalValorAcumulado);
        }
        
        async function sincronizarDados() {
            await carregarDados();
            alert('Dados sincronizados com sucesso!');
        }
        
        window.onload = () => {
            carregarDados();
            // Ativa a aba do mÃªs inicial apÃ³s carregar os dados
            switchMonth(currentMonth); 
        };
    </script>
</body>
</html>
