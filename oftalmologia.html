<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oftalmologia - Custos Mensais por Procedimento</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        h1 { color: #333; text-align: center; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow-x: auto; display: block; }
        th, td { padding: 8px; text-align: right; border-bottom: 1px solid #ddd; white-space: nowrap; font-size: 0.85em; }
        th { background-color: #4CAF50; color: white; text-align: center; font-size: 0.8em; position: sticky; left: 0; z-index: 1; }
        tr:hover { background-color: #f5f5f5; }
        .total { font-weight: bold; background-color: #e8f5e8; text-align: center; }
        .resumo { background: #fff; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .loading { text-align: center; color: #666; font-style: italic; }
        .error { color: #d32f2f; text-align: center; }
        .diferenca { background-color: #fff3cd; } /* Destaque para coluna Diferença */
    </style>
</head>
<body>
    <h1>Custos Mensais - Oftalmologia</h1>
    
    <div class="resumo" id="resumo">
        <h2>Resumo Geral (Carregando...)</h2>
        <div class="loading">Conectando via Apps Script...</div>
    </div>
    
    <h2>Custos por Mês e Procedimento</h2>
    <div style="overflow-x: auto;">
        <table id="tabela-custos">
            <thead>
                <tr>
                    <th>Mês</th>
                    <th>Custo Geral</th>
                    <th>Consultas</th>
                    <th>Biometria</th>
                    <th>Campo Visual</th>
                    <th>Retinografia Colorida</th>
                    <th>Microscopia Especular</th>
                    <th>Topografia</th>
                    <th>Paquimetria US</th>
                    <th>Angiografia</th>
                    <th>Tomografia OCT</th>
                    <th>Ecografia Ocular</th>
                    <th>Cirurgia Catarata</th>
                    <th>Cirurgia Refrativa</th>
                    <th>Plástica Ocular</th>
                    <th>Glaucoma - Trab</th>
                    <th>Capsulotomia Laser</th>
                    <th>Iridotomia Laser</th>
                    <th>Retina - Vitrectomia</th>
                    <th>Fotocoagulação Laser</th>
                    <th>Anti-VEGF</th>
                    <th>Estrabismo</th>
                    <th>Pterígio</th>
                    <th>Fixo</th>
                    <th>Total</th>
                    <th class="diferenca">Diferença</th>
                </tr>
            </thead>
            <tbody id="tbody-custos">
                <tr><td colspan="26" class="loading">Carregando dados da planilha...</td></tr>
            </tbody>
            <tfoot id="tfoot-totals">
                <tr class="total">
                    <td colspan="26"><strong>Carregando totais...</strong></td>
                </tr>
            </tfoot>
        </table>
    </div>
    
    <script>
        // URL do seu Apps Script implantado
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw-CxvpNHhYvCY-eONSPLvM8-tCZ8ZNiUhOasvqWwjQgtXDvhTtWNusDwf_pZskCivl/exec';
        
        // Função auxiliar para converter valores (ex.: 'R$ 1.500,00' -> 1500)
        function parseValor(val) {
            if (!val) return 0;
            const cleaned = val.toString().replace(/[^\d,]/g, '').replace(',', '.');
            return parseFloat(cleaned) || 0;
        }
        
        async function carregarDados() {
            try {
                console.log('Buscando dados de:', SCRIPT_URL);
                const response = await fetch(SCRIPT_URL);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status} - Verifique se o Apps Script está implantado corretamente.`);
                }
                
                const data = await response.json();
                console.log('Dados recebidos do Apps Script:', data);
                
                if (data.error) {
                    throw new Error(`Erro no Apps Script: ${data.error}. Verifique logs no editor do Apps Script.`);
                }
                
                const meses = data.meses || [];
                const numMeses = data.numMeses || meses.length;
                const totalGeral = data.totalGeral || 0;
                const totalDif = data.totalDif || 0;
                const mediaMensal = data.mediaMensal || (totalGeral / numMeses);
                
                // Atualiza resumo
                document.getElementById('resumo').innerHTML = `
                    <h2>Resumo Geral</h2>
                    <p><strong>Meses Analisados:</strong> ${numMeses}</p>
                    <p><strong>Total Geral de Custos:</strong> <code>R$ ${totalGeral.toLocaleString('pt-BR')}</code></p>
                    <p><strong>Média Mensal:</strong> <code>R$ ${mediaMensal.toLocaleString('pt-BR')}</code></p>
                    <p><strong>Soma das Diferenças:</strong> <code>R$ ${totalDif.toLocaleString('pt-BR')}</code></p>
                    <p><strong>Data da Última Atualização:</strong> ${data.dataAtualizacao || new Date().toLocaleDateString('pt-BR')}</p>
                `;
                
                // Preenche tabela de custos
                const tbody = document.getElementById('tbody-custos');
                tbody.innerHTML = '';
                
                meses.forEach(row => {
                    const tr = document.createElement('tr');
                    let html = `<td>${row[0] || ''}</td>`;  // Mês (coluna A, índice 0)
                    
                    for (let i = 1; i < row.length && i <= 25; i++) {  // Colunas B a Z (1 a 25)
                        const val = parseValor(row[i]);
                        const classe = (i === 25) ? ' class="diferenca"' : '';  // Destaque para Diferença (Z, índice 25)
                        html += `<td${classe}><code>R$ ${val.toLocaleString('pt-BR')}</code></td>`;
                    }
                    
                    tr.innerHTML = html;
                    tbody.appendChild(tr);
                });
                
                // Atualiza rodapé com totais
                document.getElementById('tfoot-totals').innerHTML = `
                    <tr class="total">
                        <td><strong>Total Geral</strong></td>
                        <td><strong><code>R$ ${totalGeral.toLocaleString('pt-BR')}</code></strong></td>
                        <td colspan="23"></td>  <!-- Espaço para procedimentos; totais por coluna podem ser adicionados se no JSON -->
                        <td class="diferenca"><strong><code>R$ ${totalDif.toLocaleString('pt-BR')}</code></strong></td>
                    </tr>
                    <tr class="total">
                        <td colspan="25"><strong>Média Mensal Geral: <code>R$ ${mediaMensal.toLocaleString('pt-BR')}</code></strong></td>
                        <td></td>
                    </tr>
                `;
                
                console.log('Dados carregados com sucesso! Número de meses:', numMeses);
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                document.getElementById('resumo').innerHTML = `
                    <h2>Erro na Conexão</h2>
                    <p class="error">${error.message}</p>
                    <p class="error"><small>Dicas: 
                        <ul>
                            <li>Teste a URL do Apps Script no navegador para ver o JSON.</li>
                            <li>Verifique se a planilha está compartilhada com jg-minis-backup@jg-minis-portal.iam.gserviceaccount.com.</li>
                            <li>Confira logs no Apps Script (Extensões > Apps Script > Execuções).</li>
                        </ul>
                    </small></p>
                `;
                document.getElementById('tbody-custos').innerHTML = `<tr><td colspan="26" class="error">Falha ao carregar dados. Recarregue ou verifique configurações.</td></tr>`;
            }
        }
        
        // Carrega ao inicializar a página
        window.onload = carregarDados;
        
        // Opcional: Atualiza a cada 30 minutos (descomente se quiser)
        // setInterval(carregarDados, 1800000);
    </script>
    
    <footer style="text-align: center; margin-top: 40px; color: #666;">
        <p>Dashboard de custos oftalmológicos conectado ao Apps Script. Dados atualizados automaticamente.</p>
    </footer>
</body>
</html>
